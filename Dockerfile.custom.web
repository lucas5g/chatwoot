FROM ruby:3.4.4

ENV RAILS_ENV=production \
    NODE_ENV=production \
    RACK_ENV=production \
    LANG=C.UTF-8 \
    BUNDLE_PATH=/usr/local/bundle

# 1. Instala curl e gnupg primeiro
RUN apt-get update -qq && \
    apt-get install -y \
      curl \
      gnupg \
    && rm -rf /var/lib/apt/lists/*

# 2. Adiciona repositório do Node.js usando curl
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash -

# 3. Instala todas as dependências do sistema
RUN apt-get update -qq && \
    apt-get install -y \
      git \
      build-essential \
      libpq-dev \
      postgresql-client \
      nodejs \
      imagemagick \
    && rm -rf /var/lib/apt/lists/*

# 4. Clona seu repositório customizado
WORKDIR /app
RUN git clone https://github.com/lucas5g/chatwoot-custom.git .
# ou um branch específico:
# RUN git clone -b main https://github.com/lucas5g/chatwoot-custom.git .

# 5. Instala dependências Ruby e Node
RUN gem install bundler -v 2.5.6
RUN bundle install --without development test
RUN corepack enable && \
    corepack prepare pnpm@latest --activate && \
    pnpm install --frozen-lockfile


# 6. Compila os assets
RUN SECRET_KEY_BASE=dummy bundle exec rails assets:precompile


# 7. Dá permissão ao entrypoint
RUN chmod +x docker/entrypoints/rails.sh

# 8. Define o entrypoint e comando padrão
ENTRYPOINT ["docker/entrypoints/rails.sh"]
CMD ["bundle", "exec", "rails", "s", "-b", "0.0.0.0", "-p", "3000"]
